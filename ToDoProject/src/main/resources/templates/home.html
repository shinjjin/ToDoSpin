<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Home</title>
    <style>
        /* Seitenlayout: links Tasks, rechts Wheel */
        .page { display:flex; gap:2rem; align-items:flex-start; padding:1rem; }
        .task-container { flex:1; }

        /* Wheel-Bereich rechts */
        #wheel-area { width: 460px; display:flex; flex-direction:column; align-items:center; margin-left:auto; }
        .spin-container { margin-top: 0.5rem; display:flex; gap:1rem; align-items:center; justify-content:center; }

        /* Wheel-Größe und Styling */
        #wheel-wrapper { position: relative; width: 420px; height: 420px; }
        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 4s cubic-bezier(.1,.9,.2,1);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            background: #fff;
            display:flex; align-items:center; justify-content:center;
        }
        #wheel .label {
            position: absolute;
            left: 50%;
            top: 50%;
            transform-origin: 0 0;
            font-size: 13px;
            white-space: nowrap;
            pointer-events: none;
            color: #222;
        }
        /* Pointer oben mittig */
        #pointer { 
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translate(-50%);
            width: 36px;
            height: 36px;
            z-index: 20;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
         }

        #pointer svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .spin-center {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 30;
        }

        .spin-center form { pointer-events: auto; }

        .spin-btn--center {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            background: #c0392b;
            color: #fff;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform .12s ease;
        }

        .spin-btn--center:active { transform: scale(.96);}

        .wheel-empty { display:flex; align-items:center; justify-content:center; width:420px; height:420px; border-radius:50%; background:#f8f8f8; color:#666; font-size:16px; }
        /*.spin-btn { padding: 0.6rem 1rem; cursor:pointer; }*/

        /* Responsive: auf kleinen Bildschirmen untereinander anordnen */
        @media (max-width: 900px) {
            .page { flex-direction: column; }
            #wheel-area { width: 100%; margin-left: 0; order: 2; }
            .task-container { order: 1; }
            #wheel-wrapper { width: 320px; height: 320px; }
            .wheel-empty { width:320px; height:320px; }
            #pointer { top: -10px; width: 30px; height: 30px; }
            .spin-btn--center { width: 56px; height: 56px; font-size: 14px; }
        }
    </style>
</head>
<body>
<div class="page">
    <div class="task-container">
        <h2>ToDo-List</h2>

        <h3>Current Task</h3>
        <th:block th:each="task : ${tasks}">
            <!--Anzeige der Task, die durch Spin ausgewählt wurde-->
            <div th:if="${task.chosen and !task.done}">
                <form th:action="@{/taskDone}" method="post">
                    <input type="hidden" name="id" th:value="${task.id}">                <!--Verstecktes Feld mit Task id-->
                    <button type="submit">Erledigt</button>                               <!--Task wird auf erledigt gesetzt-->
                    <p th:text="${task.name}"></p>
                </form>

            </div>
        </th:block>

        <h3>To Do</h3>
        <form th:action="@{/add}" method="post">                                 <!--Formular zum Hinzufügen einer Task-->
            <input type="text" name="text" placeholder="Neue Task..." required aria-label="Neue Task">    <!--Eingabefeld-->
            <button type="submit">Hinzufügen</button>
        </form>
        <!--Ordner zum Anzeigen der eingegebenen Tasks ohne die, die schon erledigt sind-->
        <div th:each="task : ${tasks}" class="task">
            <div th:if="${!task.done}">
                <!--th:each iteriert später über alle Tasks die vom Controller ins Model gelegt werden-->
                <form th:action="@{/edit}" method="post">
                    <!--Formular zum Bearbeiten der Tasks-->
                    <input type="hidden" name="id" th:value="${task.id}">                <!--Verstecktes Feld mit Task id-->
                    <input type="text" name="text" th:value="${task.name}" aria-label="Task Name">
                    <!--Eingabefeld mit aktuellem Task Namen-->
                    <button type="submit">Bearbeiten</button>
                </form>
                <form th:action="@{/delete}" method="post">
                    <input type="hidden" name="id" th:value="${task.id}">
                    <button type="submit">Löschen</button>
                </form>
            </div>
        </div>

        <h3>Finished Tasks</h3>
        <th:block th:each="task : ${tasks}">
            <!--Anzeige der Tasks, die erledigt wurden-->
            <div th:if="${task.done}">
                <p th:text="${task.name}"></p>
            </div>
        </th:block>
    </div>

    <!-- Wheel-Bereich rechts -->
    <aside id="wheel-area" aria-label="Spinning Wheel Bereich">
        <!--<div class="spin-container">
            <form id="spinForm" th:action="@{/spin}" method="post">
                <button id="spinBtn" class="spin-btn" type="submit">Spin</button>
            </form>
        </div>-->

        <!-- Versteckte Daten für JS: alle Tasks als data-Attribute -->
        <div id="task-data" style="display:none;">
            <div class="task-data" th:each="task : ${tasks}"
                 th:attr="data-name=${task.name}, data-done=${task.done}, data-id=${task.id}, data-chosen=${task.chosen}"></div>
        </div>

        <!-- Wheel Wrapper -->
        <div id="wheel-wrapper">
            <div id="pointer" aria-hidden="true">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                    <path fill="#c0392b" d="M13 3h-2v10H5l7 8 7-8h-6z"/>
                </svg>
            </div>

            <div id="wheel" aria-hidden="true"></div>

            <div class="spin-center" aria-hidden="false">
                <form id="spinForm" th:action="@{/spin}" method="post">
                    <input type="hidden" name="chosenId" id="chosenId" value="">
                    <button id="spinBtn" class="spin-btn--center" type="submit" aria-label="Drehe das Rad">Spin</button>
                </form>
            </div>
        </div>

    </aside>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        function parseTasks(){
            const nodes = document.querySelectorAll('#task-data .task-data');
            const arr = [];
            nodes.forEach(n => {
                arr.push({
                    id: Number(n.dataset.id),
                    name: n.dataset.name || '',
                    done: n.dataset.done === 'true',
                    chosen: n.dataset.chosen === 'true'
                });
            });
            return arr;
        }

        function makeColors(n){
            const base = ["#f94144","#f3722c","#f9c74f","#90be6d","#43aa8b","#577590","#277da1","#8d99ae"];
            const colors = [];
            for(let i=0;i<n;i++) colors.push(base[i % base.length]);
            return colors;
        }

        function renderWheel(tasks){
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';
            wheel.style.transform = 'rotate(0deg)';
            const undone = tasks.filter(t => !t.done);
            if(undone.length === 0){
                wheel.className = 'wheel-empty';
                wheel.textContent = 'Keine Tasks zum Spinnen';
                return;
            }
            const segment = 360 / undone.length;
            const colors = makeColors(undone.length);
            // build conic-gradient
            let gradient = 'conic-gradient(';
            for(let i=0;i<undone.length;i++){
                const start = i*segment;
                const end = (i+1)*segment;
                gradient += `${colors[i]} ${start}deg ${end}deg` + (i===undone.length-1?')':',');
            }
            wheel.style.background = gradient;
            wheel.className = '';

            // dynamic radius for label translation
            const radius = Math.max(100, Math.floor(wheel.clientWidth / 2) - 60);

            // add labels
            for(let i=0;i<undone.length;i++){
                const angle = (i*segment + segment/2); // center angle
                const label = document.createElement('div');
                label.className = 'label';
                // rotate to angle, move outwards by radius, then rotate text to be more readable
                label.style.transform = `rotate(${angle}deg) translate(${radius}px) rotate(90deg)`;
                label.textContent = undone[i].name || '—';
                wheel.appendChild(label);
            }
        }

        function setupSpin(){
            const form = document.getElementById('spinForm');
            const btn = document.getElementById('spinBtn');
            const wheel = document.getElementById('wheel');
            const chosenInput = document.getElementById('chosenId');

            btn.addEventListener('click', function(e){
                const tasks = parseTasks();
                const undone = tasks.filter(t => !t.done);
                if(undone.length === 0) return; // standard submit if none
                e.preventDefault();

                const extra = (Math.floor(Math.random()*3) + 3) * 360; // 3-5 turns
                const randomStop = Math.floor(Math.random()*360);
                const deg = extra + randomStop;

                const segment = 360 / undone.length;
                const pointerOffset = 270;
                const adjusted = (pointerOffset - (randomStop % 360) + 360) % 360;
                const taskIndex = Math.floor(adjusted / segment) % undone.length;
                if (taskIndex < 0) taskIndex += undone.length;

                const chosen = undone[taskIndex];

                if (chosen) {
                    chosenInput.value = chosen.id;
                    chosenInput.setAttribute('name', 'chosenId');
                }else {
                    chosenInput.removeAttribute('name');
                }

                wheel.style.transition = 'transform 4s cubic-bezier(.1,.9,.2,1)';
                wheel.style.transform = `rotate(${deg}deg)`;
                // after animation, submit form so backend can pick a task (server-side determines chosen)
                setTimeout(()=>{ form.submit(); }, 4200);
            });
        }

        // Init
        const tasks = parseTasks();
        renderWheel(tasks);
        setupSpin();

        // Re-render on resize to adjust label radius
        window.addEventListener('resize', () => { renderWheel(parseTasks()); });
        });
</script>
</body>
</html>