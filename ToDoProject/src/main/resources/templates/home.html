<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ToDo & Gl√ºcksrad</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Layout-Fix f√ºr Nebeneinander-Darstellung */
        .page-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Verhindert, dass der Main-Style das Layout zerschie√üt */
        .task-container {
            margin: 0 !important;
            flex: 1;
            max-width: 600px;
        }

        .wheel-column {
            flex: 0.8;
            max-width: 450px;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            position: sticky;
            top: 20px;
        }

        #canvas { width: 100%; height: auto; border-radius: 50%; border: 5px solid #333; }
        #pointer { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #333; margin: 0 auto -10px auto; position: relative; z-index: 10; }

        .spin-btn {
            margin-top: 20px;
            background-color: #fbbf0d !important;
            color: white;
            font-weight: bold;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .chosen-task {
            background: #fff3e0;
            border: 2px solid #fbbf0d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="page-wrapper">

    <div class="task-container">
        <h2>ToDo-Manager</h2>

        <div th:each="task : ${tasks}" th:if="${task.chosen and !task.done}" class="chosen-task">
            <strong>üéØ Aktuelle Aufgabe:</strong>
            <p th:text="${task.name}" style="font-size: 1.2rem; margin: 10px 0;"></p>
            <form th:action="@{/taskDone}" method="post">
                <input type="hidden" name="id" th:value="${task.id}">
                <button type="button" onclick="completeTaskConfetti(this)">
                    Als erledigt markieren !
                </button>
            </form>
        </div>

        <h3>To Do</h3>
        <form th:action="@{/add}" method="post">
            <input type="text" name="text" placeholder="Neue Task..." required>
            <button type="submit">Hinzuf√ºgen</button>
        </form>

        <form th:action="@{/deleteAll}" method="post" style="margin-top: 10px;">
            <button type="submit">Alle Tasks l√∂schen</button>
        </form>

        <div th:each="task : ${tasks}" class="task">
            <div th:if="${!task.done}">
                <form th:action="@{/edit}" method="post">
                    <input type="hidden" name="id" th:value="${task.id}">
                    <input type="text" name="text" th:value="${task.name}">
                    <button type="submit" class="icon-button edit">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </form>
                <form th:action="@{/delete}" method="post">
                    <input type="hidden" name="id" th:value="${task.id}">
                    <button type="submit" class="icon-button edit">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </form>
            </div>
        </div>
        <h3 style="margin-top: 30px;">Erledigt</h3>
        <div th:each="task : ${tasks}" th:if="${task.done}" class="task" style="opacity: 0.6; text-decoration: line-through;">
            <span th:text="${task.name}"></span>
        </div>
    </div>

    <div class="wheel-column">
        <h3>Gl√ºcksrad</h3>
        <div id="pointer"></div>
        <canvas id="canvas" width="400" height="400"></canvas>
        <button id="spinBtn" class="spin-btn" onclick="startSpin()">JETZT DREHEN</button>
    </div>
</div>


<script>
    function completeTaskConfetti(button) {
        const form = button.closest("form");

        //Gold Animation
        button.classList.add("goldenglow");

        //Button Position ermitteln
        const rect = button.getBoundingClientRect();

        //Stelle an der das Konfetti erscheinen soll, basierend auf den Abmessungen des Fensters
        const x = (rect.left + rect.width / 2) / window.innerWidth;
        const y = (rect.top + rect.height / 2) / window.innerHeight;

        //Konfetti
        confetti({
            particleCount: 25,
            spread: 180,
            startVelocity: 20,
            gravity: 0.9,
            ticks: 80,
            origin: { x, y },
            colors: ['#fbbf0d', '#ff9800', '#ffffff']
        });
// Kurze Verz√∂gerung, damit man das Konfetti sieht, bevor der Redirect kommt, genau wie in der anderen Konfetti Methode
        setTimeout(() => {
            form.submit();
        }, 1750);
    }
</script>



<script th:inline="javascript">
    let tasksForWheel = [];
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let currentAngle = 0;

    // L√§dt nur die offenen Tasks f√ºr das Rad
    async function loadWheelData() {
        const response = await fetch('/api/tasks/open');
        tasksForWheel = await response.json();
        drawWheel();


        // Button aktivieren/deaktivieren
        const spinBtn = document.getElementById("spinBtn");
        if (tasksForWheel.length < 2) {
            spinBtn.disabled = true;
            spinBtn.style.opacity = "0.5"; // optional f√ºr visuelles Feedback
            spinBtn.textContent = "Mindestens 2 Aufgaben n√∂tig";
        } else {
            spinBtn.disabled = false;
            spinBtn.style.opacity = "1";
            spinBtn.textContent = "JETZT DREHEN";
        }

    }

    function drawWheel() {
        if (tasksForWheel.length === 0) {
            ctx.clearRect(0,0,400,400);
            ctx.font = "16px Arial";
            ctx.fillText("Keine Aufgaben", 150, 200);
            return;
        }
        const arc = (2 * Math.PI) / tasksForWheel.length;
        const colors = ['#d23d2d', "#6e433d", '#f5c065', '#31603d', '#f8eecb'];

        ctx.clearRect(0,0, 400, 400);
        tasksForWheel.forEach((task, i) => {
            const angle = currentAngle + i * arc;
            ctx.beginPath();
            ctx.fillStyle = colors[i % colors.length];
            ctx.moveTo(200, 200);
            ctx.arc(200, 200, 190, angle, angle + arc);
            ctx.fill();
            ctx.stroke();
            ctx.save();
            ctx.translate(200, 200);
            ctx.rotate(angle + arc / 2);
            ctx.fillStyle = "white";
            ctx.font = "bold 14px Arial";
            ctx.fillText(task.name.substring(0, 12), 70, 5);
            ctx.restore();
        });
    }

    function startSpin() {
        let velocity = Math.random() * 0.3 + 0.4;
        const animate = () => {
            velocity *= 0.985;
            currentAngle += velocity;
            drawWheel();
            if (velocity > 0.002) requestAnimationFrame(animate);
            else finishSpin();
        };
        animate();
    }

    function finishSpin() {
    const arc = (2 * Math.PI) / tasksForWheel.length;
    const index = Math.floor(((2 * Math.PI - (currentAngle % (2 * Math.PI)) + 1.5 * Math.PI) % (2 * Math.PI)) / arc);
    const winner = tasksForWheel[index];

    // --- KONFETTI EFFEKT ---
    const duration = 3 * 1000;
    const end = Date.now() + duration;

    (function frame() {
        // Konfetti von links
        confetti({
            particleCount: 3,
            angle: 60,
            spread: 55,
            origin: { x: 0 },
            colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00']
        });
        // Konfetti von rechts
        confetti({
            particleCount: 3,
            angle: 120,
            spread: 55,
            origin: { x: 1 },
            colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00']
        });

        if (Date.now() < end) {
            requestAnimationFrame(frame);
        }
    }());

    // Kurze Verz√∂gerung, damit man das Konfetti sieht, bevor der Redirect kommt
    setTimeout(() => {
        window.location.href = "/chooseFromWheel/" + winner.id;
    }, 2000);
}

    loadWheelData();
</script>
</body>
</html>